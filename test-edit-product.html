<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Editar Producto con Nueva Imagen</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .test-product {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .test-product img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }
        .test-product-info {
            flex: 1;
        }
        .test-product-info h4 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
        }
        .test-product-info p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .btn-test {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-test:hover {
            background: var(--accent-color);
        }
        .feature-check {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .feature-check.success {
            background: #d4edda;
            color: #155724;
        }
        .feature-check.pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2>üß™ Test: Editar Producto - Actualizar Imagen</h2>
        
        <div class="instructions">
            <h4>üìã Instrucciones para probar:</h4>
            <ol>
                <li>Haz clic en "Editar Producto" en el producto de prueba</li>
                <li>En el modal que se abre, busca la secci√≥n "Imagen del Producto"</li>
                <li>Haz clic en "Subir Nueva Imagen" para cambiar la imagen</li>
                <li>Selecciona una imagen diferente (JPG, PNG, WEBP)</li>
                <li>Observa las notificaciones emergentes durante la subida</li>
                <li>Verifica que se actualice el preview autom√°ticamente</li>
                <li>Confirma que el campo URL se actualiza con la nueva imagen de Cloudinary</li>
                <li>Haz clic en "Actualizar Producto" para guardar los cambios</li>
            </ol>
        </div>

        <h3>Producto de Prueba</h3>
        <div class="test-product">
            <img src="recursos/lunilogo.png" alt="Producto de prueba">
            <div class="test-product-info">
                <h4>Diadema Elegante Rosa</h4>
                <p><strong>Precio:</strong> $15.000 | <strong>Stock:</strong> 10 unidades</p>
                <p><strong>Categor√≠a:</strong> Diademas | <strong>Color:</strong> Rosa</p>
            </div>
            <button class="btn-test" onclick="testEditProduct()">
                <i class="fas fa-edit"></i> Editar Producto
            </button>
        </div>

        <div style="margin-top: 2rem;">
            <h4>‚úÖ Funcionalidades a Verificar:</h4>
            <div class="feature-check pending" id="feature-1">
                <i class="fas fa-clock"></i> 1. Modal de edici√≥n se abre correctamente
            </div>
            <div class="feature-check pending" id="feature-2">
                <i class="fas fa-clock"></i> 2. Bot√≥n "Subir Nueva Imagen" est√° presente
            </div>
            <div class="feature-check pending" id="feature-3">
                <i class="fas fa-clock"></i> 3. Validaci√≥n de archivos funciona
            </div>
            <div class="feature-check pending" id="feature-4">
                <i class="fas fa-clock"></i> 4. Barra de progreso se muestra durante subida
            </div>
            <div class="feature-check pending" id="feature-5">
                <i class="fas fa-clock"></i> 5. Notificaciones aparecen correctamente
            </div>
            <div class="feature-check pending" id="feature-6">
                <i class="fas fa-clock"></i> 6. Preview de imagen se actualiza
            </div>
            <div class="feature-check pending" id="feature-7">
                <i class="fas fa-clock"></i> 7. URL de Cloudinary se genera autom√°ticamente
            </div>
        </div>

        <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 5px;">
            <p><strong>üí° Nota:</strong> Esta p√°gina simula un producto para probar la funcionalidad de edici√≥n con subida de imagen. Los cambios no se guardar√°n en la base de datos real.</p>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="js/supabaseClient.js"></script>
    <script src="js/cloudinary.js"></script>
    <script src="js/products.js"></script>
    <script src="js/categories.js"></script>
    
    <script>
        // Simular AdminPanel con solo las funciones necesarias para el test
        class TestAdminPanel {
            constructor() {
                this.editProgressInterval = null;
            }

            // Simular datos de producto de prueba
            getTestProduct() {
                return {
                    id: 'test-product-123',
                    name: 'Diadema Elegante Rosa',
                    category: 'diademas',
                    price: 15000,
                    color: 'Rosa',
                    size: 'Mediano',
                    image: 'recursos/lunilogo.png',
                    stock: 10,
                    description: 'Hermosa diadema rosa con detalles elegantes, perfecta para ocasiones especiales.',
                    available: true
                };
            }

            showEditProductModal(product) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.id = `edit-product-modal-${product.id}`;
                
                modal.innerHTML = `
                  <div class="modal-content edit-product-modal-content">
                    <button class="modal-close-btn" onclick="document.getElementById('edit-product-modal-${product.id}').remove()">
                      <i class="fas fa-times"></i>
                    </button>
                    
                    <div class="edit-product-header">
                      <h2><i class="fas fa-edit"></i> Editar Producto</h2>
                      <p>Modificar informaci√≥n de: <strong>${product.name}</strong></p>
                    </div>
                    
                    <form class="edit-product-form">
                      <input type="hidden" id="edit-product-id" value="${product.id}">
                      
                      <div class="form-section">
                        <h4>Informaci√≥n B√°sica</h4>
                        <div class="form-row">
                          <div class="form-group">
                            <label for="edit-product-name">Nombre del Producto *</label>
                            <input type="text" id="edit-product-name" value="${product.name || ''}" required>
                          </div>
                          <div class="form-group">
                            <label for="edit-product-category">Categor√≠a *</label>
                            <select id="edit-product-category" required>
                              <option value="diademas" selected>Diademas</option>
                              <option value="pinzas">Pinzas</option>
                              <option value="scrunchies">Scrunchies</option>
                            </select>
                          </div>
                        </div>
                        <div class="form-row">
                          <div class="form-group">
                            <label for="edit-product-price">Precio *</label>
                            <input type="number" id="edit-product-price" value="${product.price || ''}" min="0" step="100" required>
                          </div>
                          <div class="form-group">
                            <label for="edit-product-stock">Stock Disponible</label>
                            <input type="number" id="edit-product-stock" value="${product.stock || 0}" min="0">
                          </div>
                        </div>
                      </div>
                      
                      <div class="form-section">
                        <h4>Caracter√≠sticas</h4>
                        <div class="form-row">
                          <div class="form-group">
                            <label for="edit-product-color">Color</label>
                            <input type="text" id="edit-product-color" value="${product.color || ''}">
                          </div>
                          <div class="form-group">
                            <label for="edit-product-size">Tama√±o</label>
                            <select id="edit-product-size">
                              <option value="Peque√±o" ${product.size === 'Peque√±o' ? 'selected' : ''}>Peque√±o</option>
                              <option value="Mediano" ${product.size === 'Mediano' ? 'selected' : ''}>Mediano</option>
                              <option value="Grande" ${product.size === 'Grande' ? 'selected' : ''}>Grande</option>
                            </select>
                          </div>
                        </div>
                        <div class="form-group">
                          <label for="edit-product-description">Descripci√≥n</label>
                          <textarea id="edit-product-description" rows="3">${product.description || ''}</textarea>
                        </div>
                      </div>
                      
                      <div class="form-section">
                        <h4>Imagen del Producto</h4>
                        <div class="image-upload-container">
                          <div class="image-preview-wrapper">
                            <img id="edit-product-image-preview" src="${product.image || 'recursos/lunilogo.png'}" alt="Preview" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px;">
                            <div class="upload-progress-container">
                              <div id="edit-upload-progress" class="upload-progress"></div>
                            </div>
                          </div>
                          <div class="upload-controls">
                            <label for="edit-product-image-input" class="btn btn-upload">
                              <i class="fas fa-cloud-upload-alt"></i> Subir Nueva Imagen
                            </label>
                            <input type="file" id="edit-product-image-input" accept="image/*" style="display: none;">
                            <small>Formatos: JPG, PNG, WEBP (m√°x. 5MB)</small>
                          </div>
                          <div class="form-group">
                            <label for="edit-product-image-url">URL de Imagen (Cloudinary)</label>
                            <input type="text" id="edit-product-image-url" value="${product.image || ''}" placeholder="Se actualizar√° autom√°ticamente al subir" onchange="document.getElementById('edit-product-image-preview').src = this.value || 'recursos/lunilogo.png'">
                          </div>
                        </div>
                      </div>
                      
                      <div class="form-section">
                        <div class="form-group">
                          <label for="edit-product-available">
                            <input type="checkbox" id="edit-product-available" ${product.available !== false ? 'checked' : ''}>
                            Producto Disponible
                          </label>
                        </div>
                      </div>
                      
                      <div class="form-actions">
                        <button type="button" onclick="testSaveProduct('${product.id}')" class="btn btn-primary">
                          <i class="fas fa-save"></i> Actualizar Producto (Test)
                        </button>
                        <button type="button" onclick="document.getElementById('edit-product-modal-${product.id}').remove()" class="btn btn-secondary">
                          <i class="fas fa-times"></i> Cancelar
                        </button>
                      </div>
                    </form>
                  </div>
                `;
                
                document.body.appendChild(modal);
                
                // Configurar event listener para subida de imagen
                const editImageInput = document.getElementById('edit-product-image-input');
                if (editImageInput) {
                    editImageInput.addEventListener('change', (e) => this.handleEditImageUpload(e));
                    markFeatureComplete('feature-1');
                    markFeatureComplete('feature-2');
                }
            }

            async handleEditImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Validar tipo de archivo
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    this.showNotification('Error: Solo se permiten archivos de imagen (JPG, PNG, WEBP, GIF)', 'error');
                    markFeatureComplete('feature-3');
                    return;
                }

                // Validar tama√±o (5MB)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    this.showNotification('Error: La imagen debe ser menor a 5MB', 'error');
                    markFeatureComplete('feature-3');
                    return;
                }

                markFeatureComplete('feature-3');
                this.showNotification('Actualizando imagen del producto...', 'info');
                markFeatureComplete('feature-5');
                this.showEditUploadProgress();
                markFeatureComplete('feature-4');

                try {
                    // Mostrar preview inmediatamente
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('edit-product-image-preview');
                        if (preview) {
                            preview.src = e.target.result;
                            markFeatureComplete('feature-6');
                        }
                    };
                    reader.readAsDataURL(file);

                    // Subir a Cloudinary
                    const cloudinary = new CloudinaryUploader();
                    const result = await cloudinary.uploadImage(file);
                    
                    if (result.success) {
                        // Actualizar el campo de URL
                        const urlInput = document.getElementById('edit-product-image-url');
                        if (urlInput) {
                            urlInput.value = result.url;
                            markFeatureComplete('feature-7');
                        }
                        
                        // Actualizar preview con la URL de Cloudinary
                        const preview = document.getElementById('edit-product-image-preview');
                        if (preview) {
                            preview.src = result.url;
                        }
                        
                        this.showNotification('‚úÖ Nueva imagen cargada exitosamente', 'success');
                    } else {
                        this.showNotification('Error al subir la imagen: ' + (result.message || 'Error desconocido'), 'error');
                    }
                } catch (error) {
                    console.error('Error en upload de edici√≥n:', error);
                    this.showNotification('Error al subir la imagen: ' + (error.message || 'Error de conexi√≥n'), 'error');
                } finally {
                    this.hideEditUploadProgress();
                    // Limpiar el input para permitir subir la misma imagen nuevamente
                    event.target.value = '';
                }
            }

            showEditUploadProgress() {
                const progressContainer = document.querySelector('#edit-upload-progress')?.parentElement;
                const progress = document.getElementById('edit-upload-progress');
                if (progressContainer && progress) {
                    progressContainer.style.display = 'block';
                    progress.style.width = '0%';
                    
                    // Simular progreso
                    let width = 0;
                    this.editProgressInterval = setInterval(() => {
                        width += Math.random() * 15;
                        if (width >= 85) {
                            clearInterval(this.editProgressInterval);
                            progress.style.width = '85%';
                        } else {
                            progress.style.width = width + '%';
                        }
                    }, 200);
                }
            }

            hideEditUploadProgress() {
                if (this.editProgressInterval) {
                    clearInterval(this.editProgressInterval);
                }
                
                setTimeout(() => {
                    const progressContainer = document.querySelector('#edit-upload-progress')?.parentElement;
                    const progress = document.getElementById('edit-upload-progress');
                    if (progressContainer && progress) {
                        progress.style.width = '100%';
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            progress.style.width = '0%';
                        }, 500);
                    }
                }, 1000);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `admin-notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, 5000);
            }
        }

        // Inicializar test
        const testAdmin = new TestAdminPanel();

        function testEditProduct() {
            const product = testAdmin.getTestProduct();
            testAdmin.showEditProductModal(product);
        }

        function testSaveProduct(productId) {
            testAdmin.showNotification('‚úÖ Producto actualizado exitosamente (modo test)', 'success');
            setTimeout(() => {
                document.getElementById(`edit-product-modal-${productId}`).remove();
            }, 2000);
        }

        function markFeatureComplete(featureId) {
            const feature = document.getElementById(featureId);
            if (feature) {
                feature.className = 'feature-check success';
                feature.innerHTML = feature.innerHTML.replace('fa-clock', 'fa-check');
            }
        }
    </script>
</body>
</html>