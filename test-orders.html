<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test √ìrdenes - Luni Chairs</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test de Sistema de √ìrdenes</h1>
    <button onclick="crearOrdenesEjemplo()">Crear √ìrdenes de Ejemplo</button>
    <button onclick="mostrarOrdenes()">Mostrar √ìrdenes</button>
    <button onclick="limpiarOrdenes()">Limpiar √ìrdenes</button>
    <div id="resultado"></div>

    <script src="js/supabaseClient.js"></script>
    <script src="js/orders.js"></script>
    
    <script>
        async function crearOrdenesEjemplo() {
            const resultado = document.getElementById('resultado');
            
            // Crear productos de ejemplo
            const productos = [
                { id: 'prod1', name: 'Silla Ejecutiva Premium', price: 450000 },
                { id: 'prod2', name: 'Silla Gaming Pro', price: 380000 },
                { id: 'prod3', name: 'Silla Ergon√≥mica Office', price: 320000 }
            ];

            // Crear √≥rdenes de ejemplo
            const ordenes = [
                {
                    customerInfo: {
                        name: 'Juan Carlos P√©rez',
                        phone: '3001234567',
                        email: 'juan@ejemplo.com',
                        address: 'Calle 123 #45-67',
                        city: 'Bogot√°'
                    },
                    items: [
                        {
                            productId: productos[0].id,
                            product: productos[0],
                            quantity: 1,
                            color: 'Negro',
                            size: ''
                        }
                    ],
                    total: 450000
                },
                {
                    customerInfo: {
                        name: 'Mar√≠a Gonz√°lez',
                        phone: '3009876543',
                        email: 'maria@ejemplo.com',
                        address: 'Carrera 89 #12-34',
                        city: 'Medell√≠n'
                    },
                    items: [
                        {
                            productId: productos[1].id,
                            product: productos[1],
                            quantity: 2,
                            color: 'Azul',
                            size: ''
                        }
                    ],
                    total: 760000
                },
                {
                    customerInfo: {
                        name: 'Carlos Rodr√≠guez',
                        phone: '3005555555',
                        email: 'carlos@ejemplo.com',
                        address: 'Avenida 50 #78-90',
                        city: 'Cali'
                    },
                    items: [
                        {
                            productId: productos[2].id,
                            product: productos[2],
                            quantity: 1,
                            color: 'Gris',
                            size: ''
                        }
                    ],
                    total: 320000
                }
            ];

            try {
                // Crear las √≥rdenes usando el OrderManager
                for (let i = 0; i < ordenes.length; i++) {
                    const ordenData = ordenes[i];
                    const orden = await orderManager.createOrder(
                        ordenData.customerInfo,
                        ordenData.items,
                        ordenData.total
                    );
                    
                    // Simular diferentes estados
                    if (i === 1) {
                        await orderManager.updateOrderStatus(orden.id, 'confirmado');
                    } else if (i === 2) {
                        await orderManager.updateOrderStatus(orden.id, 'en_preparacion');
                    }
                    
                    console.log(`Orden ${i + 1} creada:`, orden);
                }

                resultado.innerHTML = `
                    <h3>‚úÖ √ìrdenes de ejemplo creadas exitosamente</h3>
                    <p>Se han creado 3 √≥rdenes con diferentes estados:</p>
                    <ul>
                        <li>Orden 1: Pendiente</li>
                        <li>Orden 2: Confirmada</li>
                        <li>Orden 3: En Preparaci√≥n</li>
                    </ul>
                `;
            } catch (error) {
                console.error('Error creando √≥rdenes:', error);
                resultado.innerHTML = `<h3>‚ùå Error creando √≥rdenes: ${error.message}</h3>`;
            }
        }

        async function mostrarOrdenes() {
            await orderManager.refresh();
            const ordenes = orderManager.getAllOrders();
            const stats = orderManager.getOrdersStats();
            const resultado = document.getElementById('resultado');
            
            resultado.innerHTML = `
                <h3>üìä Estad√≠sticas de √ìrdenes</h3>
                <p>Total de √≥rdenes: ${stats.total}</p>
                <p>Ingresos totales: $${stats.totalRevenue.toLocaleString('es-CO')}</p>
                
                <h3>üìã Lista de √ìrdenes</h3>
                ${ordenes.length === 0 ? '<p>No hay √≥rdenes registradas</p>' : ''}
                ${ordenes.map(orden => `
                    <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                        <h4>${orden.order_number || orden.orderNumber} - ${orden.customer_info?.name || orden.customerInfo?.name}</h4>
                        <p>Estado: ${orden.status}</p>
                        <p>Total: $${parseFloat(orden.total).toLocaleString('es-CO')}</p>
                        <p>Fecha: ${new Date(orden.created_at || orden.createdAt).toLocaleDateString('es-CO')}</p>
                    </div>
                `).join('')}
            `;
        }

        async function limpiarOrdenes() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todas las √≥rdenes?')) {
                // Limpiar localStorage
                localStorage.removeItem('luni_orders');
                
                // Limpiar cache del orderManager
                orderManager.orders = [];
                
                // Intentar limpiar Supabase (requiere permisos de admin)
                try {
                    const { error } = await supabaseClient
                        .from('orders')
                        .delete()
                        .neq('id', '00000000-0000-0000-0000-000000000000'); // Eliminar todos excepto uno inexistente
                    
                    if (error) {
                        console.warn('No se pudieron eliminar √≥rdenes de Supabase:', error.message);
                    }
                } catch (error) {
                    console.warn('No se pudieron eliminar √≥rdenes de Supabase:', error.message);
                }
                
                document.getElementById('resultado').innerHTML = '<h3>üóëÔ∏è Todas las √≥rdenes han sido eliminadas</h3>';
            }
        }

        // Mostrar √≥rdenes al cargar
        window.onload = async () => {
            await mostrarOrdenes();
        };
    </script>
</body>
</html>